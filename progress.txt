## Codebase Patterns
- Use `pyproject.toml` as the source of truth for Python deps/tooling; keep `requirements.txt` as a thin editable-install wrapper for compatibility.
- Keep credentialed/manual integration scripts under `examples/` so CI and `pytest` remain deterministic.
- Scope pytest discovery to `tests/` via `tool.pytest.ini_options.testpaths` so optional/manual scripts are never collected in CI.
- Reuse `tests/conftest.py::mock_openapi_spec` for OpenAPI filtering and comma-param behavior tests.
- Keep `server.main()` transport as `streamable-http` and cover it with a focused unit test to prevent accidental protocol regressions.
- Keep local host binding default at `127.0.0.1`; containerized runs should override with `MCP_HOST=0.0.0.0` in compose/env, not in application defaults.
- Use `FastMCP.from_openapi(..., mcp_component_fn=...)` to customize generated components; derive safety annotations directly from `route.method` and `route.operation_id`.
- Keep OAuth2 modules in `auth/` framework-agnostic and dependency-injected (optional `httpx.AsyncClient`, async token store interfaces) so they stay easy to unit-test and reuse in Sprint 4 server wiring.
- For oauth2-remote mode, keep OAuth endpoint/state logic inside `OAuthServer`; server wiring should only mount routes and inject request auth through a narrow hook (`capture MCP bearer -> resolve X token -> set outbound Authorization`).
- Auth runtime is OAuth2-remote only: `server.validate_env()` should always require `X_OAUTH2_CLIENT_ID`, `X_OAUTH2_CLIENT_SECRET`, and `X_MCP_PUBLIC_URL`, and `create_mcp()` should mount `OAuthServer` unconditionally.
- Keep oauth2-remote env validation explicit: reject non-HTTPS `X_MCP_PUBLIC_URL` and reject `X_OAUTH2_SCOPES` when `offline.access` is missing.
- Keep resiliency features split by layer: retries in transport (`RetryTransport`), rate-limit/error shaping in response hooks, and health reporting as a standalone custom route.
- FastMCP HTTP auth requires passing `auth=RemoteAuthProvider(...)` to `FastMCP.from_openapi()` â€” without it, `/mcp` returns 200 with no auth challenge and clients never initiate OAuth.

## [2026-02-24 20:05:46 CET] - [S0]
- Implemented Sprint 0 foundation: Python packaging/tooling (`pyproject.toml`), CI workflow, and deterministic test suite for OpenAPI filtering and query param normalization helpers.
- Files changed:
  - `pyproject.toml`
  - `requirements.txt`
  - `.gitignore`
  - `README.md`
  - `AGENTS.md`
  - `progress.txt`
  - `.github/workflows/ci.yml`
  - `examples/test_grok_mcp.py`
  - `tests/__init__.py`
  - `tests/conftest.py`
  - `tests/test_smoke.py`
  - `tests/test_filter_spec.py`
  - `tests/test_comma_params.py`
  - **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `filter_openapi_spec()` behavior is fully env-driven (`X_API_TOOL_ALLOWLIST`, `X_API_TOOL_DENYLIST`, `X_API_TOOL_TAGS`), so tests should always isolate env with `monkeypatch`.
    - `collect_comma_params()` reads both `components.parameters` and inline operation params, but ignores `$ref` inline entries.
    - Keep `server.py` imports of heavy runtime dependencies (`fastmcp`) lazy where possible to preserve import-time testability for pure helper functions.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Moving manual scripts from repo root can break `.env` discovery; update path logic when relocating files.
  - Useful context (e.g., "the evaluation panel is in component X")
- Sprint 0 quality baseline is `pip install -e ".[dev]" && ruff check . && pytest`.
---

## [2026-02-24 21:01:05 CET] - [S1]
- Implemented Sprint 1 Docker + transport scope: switched runtime to `streamable-http`, added Docker packaging files, and documented Docker startup with explicit host override behavior.
- Files changed:
  - `server.py`
  - `tests/test_main.py`
  - `Dockerfile`
  - `docker-compose.yml`
  - `.dockerignore`
  - `env.example`
  - `README.md`
  - `AGENTS.md`
  - `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `main()` behavior is simple to regression-test by monkeypatching `create_mcp` and asserting `run()` kwargs.
    - Docker networking behavior should live in compose env overrides, not by loosening local defaults.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - `uv pip install -e '.[dev]'` can generate local artifacts (`uv.lock`, `xmcp.egg-info`) that should stay out of commits unless intentionally managed.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Local lint/tests passed with `uv run ruff check .` and `uv run pytest`; Docker CLI was unavailable in this environment, so image/config validation must be run where Docker is installed.
---

## [2026-02-24 21:15:47 CET] - [S2]
- Implemented Sprint 2 safety annotations: auto-annotated OpenAPI-generated tools by HTTP method, wired callback into `create_mcp()`, and added optional per-operation overrides from `annotation_overrides.json`.
- Files changed:
  - `server.py`
  - `annotation_overrides.json`
  - `tests/test_safety_annotations.py`
  - `README.md`
  - `AGENTS.md`
  - `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - FastMCP OpenAPI component customization is stable via `mcp_component_fn(route, component)`, and route metadata already includes `method` and `operation_id`.
    - Safety overrides are easiest to keep deterministic by loading them once at module import and monkeypatching `ANNOTATION_OVERRIDES` in tests.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - FastMCP OpenAPI parser requires valid `responses` objects in specs used by integration tests.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `create_mcp()` can be integration-tested without network/OAuth by monkeypatching `load_openapi_spec`, `build_oauth1_client`, and `load_env`.
---

## [2026-02-24 21:22:26 CET] - [S3]
- Implemented Sprint 3 OAuth2 integration layer with standalone PKCE/token client, token persistence abstraction, and dynamic client registry.
- Files changed:
  - `auth/__init__.py`
  - `auth/x_oauth2.py`
  - `auth/token_store.py`
  - `auth/client_registry.py`
  - `tests/test_x_oauth2.py`
  - `tests/test_token_store.py`
  - `tests/test_client_registry.py`
  - `pyproject.toml`
  - `README.md`
  - `AGENTS.md`
  - `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `TokenResponse` should normalize `expires_at` at parse time so expiration checks are deterministic and kept out of route handlers.
    - OAuth2 HTTP calls are easiest to test with `pytest-httpx` by injecting/mocking `httpx.AsyncClient` interactions.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Adding new runtime modules under `auth/` requires listing the package in `pyproject.toml` so editable installs keep imports working outside the repo root.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Sprint 3 acceptance command passes: `pytest tests/test_x_oauth2.py tests/test_token_store.py tests/test_client_registry.py -v`.
---

## [2026-02-24 21:37:46 CET] - [S4]
- Implemented Sprint 4 OAuth2 remote authorization server proxy: OAuth metadata/registration/authorization/callback/token endpoints, auth mode routing in `server.py`, per-request Bearer token propagation into X API hooks, and CORS handling for Claude origins.
- Files changed:
  - `auth/oauth_server.py`
  - `server.py`
  - `env.example`
  - `README.md`
  - `AGENTS.md`
  - `progress.txt`
  - `tests/test_oauth_server.py`
  - `tests/test_auth_mode.py`
  - `tests/test_auth_middleware.py`
  - `tests/test_cors.py`
  - `tests/test_safety_annotations.py`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `OAuthServer` keeps OAuth flow state (`pending_auth`, `pending_codes`, session token indexes) explicit and testable without booting a live server.
    - Request-hook auth propagation is stable with a tiny bridge: read inbound Authorization once, store in `ContextVar`, resolve X token, then inject outbound Bearer header.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - New env validation in `create_mcp()` means tests that call it directly must set minimal mode-specific vars (oauth1 consumer key/secret or oauth2-remote trio).
  - Useful context (e.g., "the evaluation panel is in component X")
    - Sprint 4 acceptance suite passes: `pytest tests/test_oauth_server.py tests/test_auth_mode.py tests/test_auth_middleware.py tests/test_cors.py -v`.
---

## [2026-02-24 21:44:38 CET] - [S5]
- Implemented Sprint 5 production-readiness: health endpoint, rate-limit awareness, retry transport for 429/5xx, and user-friendly transformed error payloads with original X error details.
- Files changed:
  - `server.py`
  - `env.example`
  - `README.md`
  - `AGENTS.md`
  - `progress.txt`
  - `tests/test_health.py`
  - `tests/test_rate_limits.py`
  - `tests/test_retries.py`
  - `tests/test_error_messages.py`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `RetryTransport` is the correct place for retry semantics; event hooks should focus on observability and response shaping.
    - Transforming error responses into JSON inside a response hook keeps downstream tool errors consistent while preserving original `x_error` details.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Hook order matters: run `handle_rate_limits` before error transformation so 429 wait-time context is available for message formatting.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Sprint 5 acceptance suite passes: `pytest tests/test_health.py tests/test_rate_limits.py tests/test_retries.py tests/test_error_messages.py -v`.
---

## [2026-02-25 12:19:25 CET] - [S6-oauth2-remote-only]
- Removed legacy auth-mode and OAuth1 code paths; runtime now operates exclusively as OAuth2 remote with required env validation and default OAuth route mounting.
- Files changed:
  - `server.py`
  - `auth/oauth_server.py`
  - `pyproject.toml`
  - `env.example`
  - `README.md`
  - `docker-compose.yml`
  - `docs/plan.md`
  - `docs/sprints.md`
  - `tests/test_auth_mode.py`
  - `tests/test_safety_annotations.py`
  - `tests/test_health.py`
  - `tests/test_oauth_server.py`
  - `tests/test_auth_middleware.py`
  - `AGENTS.md`
  - `progress.txt`
  - **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `load_openapi_spec()` should use `httpx` directly so removing OAuth1 dependencies does not break OpenAPI bootstrap.
    - Revoked/expired X refresh tokens should map to `401 invalid_grant` in `/token` refresh responses so clients reliably trigger full re-auth.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Integration tests calling `create_mcp()` must always set the OAuth2 env trio, since mode switching no longer exists.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Full quality gate passed: `uv run ruff check .` and `uv run pytest` (`111 passed`).
---

## [2026-02-25 12:44:53 CET] - [S7-oauth2-hardening-smoke]
- Added stricter oauth2-remote startup validation, a reusable endpoint smoke script, and a tighter Docker build context.
- Files changed:
  - `server.py`
  - `tests/test_auth_mode.py`
  - `scripts/smoke_oauth_remote.sh`
  - `.dockerignore`
  - `README.md`
  - `env.example`
  - `AGENTS.md`
  - `progress.txt`
  - **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - `validate_env()` is the right place to enforce deployment-critical oauth2 rules (`https` public URL + `offline.access` scope).
    - A shell smoke script against `/health`, OAuth metadata, `/register`, and `/authorize` gives fast confidence before full E2E.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - `docker compose` smoke runs need temporary override env vars when `.env` is intentionally absent.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Verification passed with `uv run ruff check .`, `uv run pytest tests/test_auth_mode.py -q`, and `scripts/smoke_oauth_remote.sh`.
---

## [2026-02-25 14:30:00 CET] - [S8-fastmcp-auth]
- Enabled FastMCP HTTP auth so `/mcp` returns 401 on unauthenticated requests, triggering the standard OAuth discovery flow for clients like Claude.
- Added `build_session_token_verifier()` that validates session access tokens against `OAuthServer.sessions_by_access` with expiration checks.
- Wired `RemoteAuthProvider` with the session verifier into `FastMCP.from_openapi(auth=...)`.
- Files changed:
  - `server.py`
  - `tests/test_auth_middleware.py`
  - `tests/test_auth_mode.py`
  - `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered:
    - FastMCP `RemoteAuthProvider` adds `/.well-known/oauth-protected-resource/<path>` automatically; existing `OAuthServer` routes (`/.well-known/oauth-authorization-server`, `/register`, `/authorize`, `/token`) don't conflict.
    - `TokenVerifier` subclass must implement `verify_token(token) -> AccessToken | None`; returning `None` triggers 401.
  - Gotchas encountered:
    - Without `auth=` on `FastMCP.from_openapi()`, `/mcp` returns 200 with no auth challenge, so Claude never initiates OAuth.
    - `RemoteAuthProvider` requires `pydantic.AnyHttpUrl` for `base_url` and `authorization_servers`.
---
